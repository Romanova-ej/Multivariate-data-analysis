---
title: "Principal component analysis for University data"
author: "Romanova"
date: '26 октября 2018 г '
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(ade4)
library(dplyr)
library(factoextra)
library(psych)
library(corrplot)
```

```{r include=FALSE}
 na.mean <- function(vec) {
        m <- mean(vec, na.rm = TRUE)
        vec[is.na(vec)] <- m
        return(vec)
    }

```


```{r include=FALSE}
Univ<-read.table("I.txt",header=TRUE,sep=';')
Univ<-Univ[-c(26:28)]
for(i in 6:46){ 
  Univ[,i] <- as.numeric(gsub(",", ".", gsub("\\.", "", Univ[,i]))) 
}
Univ<-filter(Univ, X!="University of Califo")
Univ[,c(21:27,31:41)]<-log(Univ[,c(21:27,31:41)])
PPIND1<-filter(Univ, PPIND==1)
row.names(PPIND1)<-PPIND1$FICE
PPIND1<-PPIND1[6:46]
PPIND2<-filter(Univ,PPIND==2)
row.names(PPIND2)<-PPIND2$FICE
PPIND2<-PPIND2[6:46]

Un1<-apply(PPIND1, 2, na.mean)
Un1[,25]<-Un1[,25]^(-1)
Un1<-scale(Un1)

Un<-apply(Univ[,6:46],2,na.mean)
Un<-scale(Un)
```

Набор данных об американских университетах.
В составе даных 44 признака, харакеризующих с разных сторон уровень обучающихся в университете, его пристижность, преподавателей и т.д.
Признаков очень много, поэтому имеет смысл сразу разделить их на скоррелированные группы, в каждой из которых при помощи анализа главных компонент, получить новый признак (или, возможно, несколько интерпретируемых признаков). Также стоит учитывать, что многие признаки содержат большое колчесво NA. С этой проблемой можно бороться по-разному, здесь мы будем заменять пропуски на средние значения.

Известно, что данные сильно неоднородные по признаку  PPIND, поэтому сразу будем рассматривать подгруппу государственных университетов, (PPIND=1), так как их больше, чем частных.

Взглянем на корреляционную матрицу между всеми признаками, чтобы понять, какие признаки образуют скоррелированные блоки.
```{r}
corr1<-cor(PPIND1,use="pairwise.complete.obs")
corrplot(corr1, method = "square")
```

Первые 10 признаков -- средние баллы студентов, обучающихся в университетах, по различным тестам.
Проведем анализ главных компонент по этим 10ти признакам.
```{r}
pca.quality<-dudi.pca(Un1[,c(1:10)],nf=2,scannf = FALSE)
get_eigenvalue(pca.quality)
pca.quality$c1
```

Первая компонента -- минус сумма всех показателей (при составлении матрицы новых признаков поменяем знак, чтобы было все хорошо). То есть это в каком-то смысле общий уровень знаний студентов. Вторая компонента показывает разницу между результатами теста ACT и всеми остальными тестами.
Производим эту процедуру и с остальными признаками (не будем подробно на этом останавливаться).

```{r}
new.Univ<-data.frame(-pca.quality$li$Axis1,-pca.quality$li$Axis2)
colnames(new.Univ)<-c("quality","all&ACT")
new.Univ$applicants<--dudi.pca(Un1[,11:13],nf=1,scannf = FALSE)$li #приток студентов, количественная характеристика
new.Univ$super.students<--dudi.pca(Un1[,14:15],nf=1,scannf = FALSE)$li # процент отличников 
new.Univ$num.students<-dudi.pca(Un1[,16:17],nf=1,scannf = FALSE)$li # количество студентов (количественная характеристика)
new.Univ$tuition<-dudi.pca(Un1[,18:19],nf=1,scannf = FALSE)$li # стоимость обучения
new.Univ$fees<--dudi.pca(Un1[,20:22],nf=1,scannf = FALSE)$li # затраты на общагу и предметы, необходимые для обучения и жизни в кампусе
new.Univ$competence<-dudi.pca(Un1[,23:24],nf=1,scannf = FALSE)$li # компетентность преподавателей 
new.Univ$fs.ratio<-Un1[,25] # отношение числа преподавателей к числу студентов (чем больше, тем лучше)
new.Univ$donate<-Un1[,26] # процент успешных выпускников
new.Univ$instruct<-Un1[,27] # средства, выделяемые на одного ученика 
new.Univ$graduate<-Un1[,28] # процент выпустившихся судентов
new.Univ$salary<--dudi.pca(Un1[,29:36],nf=1,scannf = FALSE)$li # заработок преподавателей 
new.Univ$num.teachers<--dudi.pca(Un1[,37:41],nf=1,scannf = FALSE)$li # количество преподавателей (количественная характеристика)
new.Univ<-as.matrix(new.Univ)
new.Univ<-as.data.frame(new.Univ)
```

Таким образом составили матрицу новых признаков.
Проведем для нее PCA.


```{r}
res.pca<-dudi.pca(new.Univ,nf=14,scannf = FALSE)
fviz_eig(res.pca)

```

Собственные числа ($\lambda_{i}$):
```{r}
get_eigenvalue(res.pca)
```

Первые 5 собственных чисел больше единицы. Пять первых компонент объясняют 73.8% дисперсии. На scree plot не совсем понятно, с какого момента камни начинают сыпаться, но, скорее всего, это все же 3 компоненты. Как будет позже показано, более менее интерпретируются тоже только три первые компоненты. Однако было принято решение использовать 5 компонент, так как 3 компоненты объясняют только 57% разброса, а хочется побольше.

Собственные векторы ($U_{i}$): 
```{r}
res.pca$c1
```

Первые две компоненты удобно интерпретировать при помощи следующего графика.
```{r}
fviz_pca_var(res.pca,
             col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE   
             )
```

Первая компонента суть общий уровень университета. Вторая компонента -- разница, между размером университета и различными показателями качества. С последующими главными компонентами сложнее (опять смотрим на собственные векторы), 3ю главную компоненту можно с натяжкой интерпретировать как разницу между востребованностью вуза у талантливых студентов и материальными аспектами обучения. То есть это, в какой-то мере, характеристика хороших, но не очень выпендрежных и процветающих вузов. 4я компонента -- разница между стоимостью обучения в вузе и объемом дополнительных расходов (соответствующие переменные дают примерно одинаковый вклад 0.6), при этом с учетом разницы между процентом отличников и процентом студентов, сумевших дойти до конца обучения (обе компоненты дают вклад около 0.3).

На следующем графике индивиды нарисованы в плоскости первых двух главных компонент.
```{r}
fviz_pca_biplot(res.pca, repel = TRUE,
                col.var = "#2E9FDF", 
                col.ind = "#696969",  
                label = "var"
                )
```



